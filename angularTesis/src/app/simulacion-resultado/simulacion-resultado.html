<body>
  <h1>Simulación de Escenarios Académicos</h1>

  <!-- Toast de confirmación -->
  <div *ngIf="showToast" class="toast" [class.success]="toast?.kind === 'success'" [class.info]="toast?.kind === 'info'"
    [class.error]="toast?.kind === 'error'">
    {{ toast?.text }}
  </div>

  <section class="simulacion-intro">
    <h2>Resultados de la Simulación</h2>
    <h3><span class="nombre">{{ nombreSimulacion }}</span></h3>
    <p>
      Basado en tu progreso académico, preferencias y plan de estudios, te mostramos una simulación personalizada con
      las materias para tu próximo semestre. Con esto podrás conocer qué materias cursar para avanzar de forma eficiente
      y tomar decisiones informadas.
    </p>
    <button class="visualizar-simulacion" (click)="visualizarSimulacion()">Visualizar Simulación en Plan de
      Estudios</button>
  </section>

  <section *ngIf="resultadoSimulacion" class="simulacion-resultados">
    <!-- Ancla para scroll: id="sem-<número>" -->
    <div *ngFor="let semestre of resultadoSimulacion | keyvalue" class="resultado-semestre"
      [attr.id]="'sem-' + semestre.key">
      <h2>Semestre {{ semestre.key }}</h2>

      <table class="materias-table">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nombre Materia</th>
            <th>Créditos</th>
            <th>Semestre</th>
            <th>Tipo</th>
            <th class="col-recom">Recomendación</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let materia of obtenerMaterias(semestre.value); let i = index">
            <td>{{ materia.codigo }}</td>
            <td>{{ materia.nombre }}</td>
            <td>{{ materia.creditos }}</td>
            <td>{{ materia.semestre }}</td>
            <td>{{ obtenerNombre(materia.tipo!) }}</td>
            <td class="col-recom">
              <button *ngIf="esReemplazable(materia); else bloqueado" class="btn-recom"
                title="Elegir desde Recomendaciones" (click)="irARecomendaciones(materia, semestre.key, i)"
                aria-label="Elegir recomendación">
                <i class="fa-solid fa-check"></i>
              </button>
              <ng-template #bloqueado>
                <button class="btn-bloqueado" title="No aplica" disabled aria-label="No aplica">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="resumen-container">
        <h2>Resumen para Semestre {{ semestre.key }}</h2>

        <div class="semestre-card">
          <div class="card-header">
            <h3>Semestre {{ semestre.key }}</h3>
          </div>

          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-item">
                <i class="fas fa-book-open"></i>
                <span><strong>Materias a cursar:</strong></span>
                <span class="stat-value">{{ calcularResumen(semestre.value).totalMaterias }}</span>
              </div>
              <div class="stat-item">
                <i class="fas fa-star"></i>
                <span><strong>Total de créditos:</strong></span>
                <span class="stat-value">{{ calcularResumen(semestre.value).totalCreditos }}</span>
              </div>
              <div class="stat-item">
                <i class="fa-solid fa-clock"></i>
                <span><strong>Horas de estudio por día:</strong></span>
                <span class="stat-value">{{ calcularResumen(semestre.value).horasEstudio }}</span>
              </div>
              <div class="stat-item">
                <i class="fa-solid fa-circle-exclamation"></i>
                <span><strong>Créditos pendientes:</strong></span>
                <span class="stat-value">{{ calcularCreditosFaltantesPorSemestre(semestre.key) }}</span>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="chart-section">
        <h2>Porcentaje por Tipo de Materia</h2>
        <div [id]="'pie-chart-semestre-' + semestre.key" class="pie-chart-container"></div>
      </div>

    </div>
  </section>

  <hr class="divider" />

  <section class="resumen-general">
    <h2>Resumen General de Simulaciones</h2>
    <p>
      Este resumen reúne las estadísticas más importantes de tu simulación académica. Úsalo para visualizar tu carga
      promedio, estimar tu ritmo de avance y planificar mejor tus próximos semestres.
    </p>

    <table>
      <thead>
        <tr>
          <th>Estadística</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Materias en promedio por semestre</td>
          <td>{{ estadisticasGenerales.promedioMaterias }}</td>
        </tr>
        <tr>
          <td>Créditos en promedio por semestre</td>
          <td>{{ estadisticasGenerales.promedioCreditos }}</td>
        </tr>
        <tr>
          <td>Créditos faltantes hasta última simulación</td>
          <td>{{ estadisticasGenerales.creditosFaltantes }}</td>
        </tr>
        <tr>
          <td>Semestre con mayor carga</td>
          <td>{{ estadisticasGenerales.semestreMayorCarga }}</td>
        </tr>
      </tbody>
    </table>
  </section>

  <button class="nueva-simulacion" (click)="volverFormSimulacion()">Generar Nueva Simulación</button>
  <button *ngIf="!simulacionGuardada" class="guardar-simulacion" (click)="guardarSimulacion()">Guardar
    Simulación</button>

  <!-- Modal para confirmar que se guardó -->
  <div class="modal-backdrop" *ngIf="mostrarModalGuardar">
    <div class="modal-custom">
      <h3>Simulación guardada con éxito</h3>
      <p>Puede revisarla en cualquier momento en el historial.</p>
      <div class="modal-buttons">
        <button class="btn-cerrar" (click)="mostrarModalGuardar = false">Cerrar</button>
      </div>
    </div>
  </div>
</body>