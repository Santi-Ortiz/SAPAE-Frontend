<section class="recomendaciones-container">
  <h1 class="titulo-principal">Recomendación de Materias</h1>
  <p class="descripcion-seccion">
    Teniendo en cuenta tus gustos, preferencias y requerimientos específicos,
    el sistema te ofrecerá una recomendación personalizada de materias.
  </p>

  <div class="formulario">
    <!-- Bloque del textarea + nota SIEMPRE visible y alineada -->
    <div class="input-block">
      <textarea [(ngModel)]="pregunta" name="pregunta"
        placeholder="Tema de interés, gustos, preferencias para la temática central de la materia"></textarea>

      <div class="hint nota-modelo">
        La información proporcionada por el modelo debe ser validada por el estudiante.
      </div>
    </div>

    <!-- Tipo de materia -->
    <div class="tipo-materia">
      <label for="tipo">Tipo de materia</label>
      <select id="tipo" name="tipo" [(ngModel)]="tipo">
        <option value="cualquiera">Cualquiera</option>
        <option value="énfasis">Énfasis</option>
        <option value="electivas">Electivas</option>
        <option value="electivas_ciencias_basicas">Electivas Ciencias Básicas</option>
        <option value="complementarias">Complementarias</option>
      </select>
    </div>

    <!-- ===== Switch de modo de créditos ===== -->
    <div class="switch-modo">
      <span class="switch-label">Modo de créditos</span>
      <label class="toggle">
        <input
          type="checkbox"
          #modeChk
          [checked]="modoCreditos === 'rango'"
          (change)="onToggleModo(modeChk.checked)"
        />
        <span class="toggle-track">
          <span class="toggle-option" [class.active]="modoCreditos === 'exacto'">Exacto</span>
          <span class="toggle-option" [class.active]="modoCreditos === 'rango'">Rango</span>
          <span class="toggle-thumb"></span>
        </span>
      </label>
    </div>

    <!-- ===== Créditos: EXACTO ===== -->
    <div class="creditos-control" *ngIf="modoCreditos === 'exacto'">
      <label for="creditos">Créditos de la materia</label>

      <div class="creditos-chip pretty">
        <button
          type="button"
          class="chip-btn chip-btn--minus"
          (click)="decCreditos()"
          [disabled]="cargando || creditos === 'cualquiera'"
          aria-label="Disminuir créditos"
        ><span class="sym">−</span></button>

        <div class="chip-value" title="Créditos seleccionados" aria-live="polite">
          {{ creditos === 'cualquiera' ? 'Cualquiera' : creditos }}
        </div>

        <button
          type="button"
          class="chip-btn chip-btn--plus"
          (click)="incCreditos()"
          [disabled]="cargando"
          aria-label="Aumentar créditos"
        ><span class="sym">+</span></button>

        <button
          type="button"
          class="chip-any"
          (click)="setCualquieraCreditos()"
          [disabled]="cargando"
          [attr.aria-pressed]="(creditos === 'cualquiera') ? 'true' : 'false'"
        >
          Cualquiera
        </button>
      </div>

      <div class="hint" *ngIf="creditos === 'cualquiera'">
        Sin restricción de créditos.
      </div>
    </div>

    <!-- ===== Créditos: RANGO ===== -->
    <div class="creditos-range" *ngIf="modoCreditos === 'rango'">
      <div class="range-col">
        <label>Mín</label>
        <div class="creditos-chip pretty">
          <button type="button" class="chip-btn chip-btn--minus"
                  (click)="decMin()"
                  [disabled]="cargando || creditosMin === 'cualquiera'">−</button>

          <div class="chip-value">
            {{ creditosMin === 'cualquiera' ? 'Cualquiera' : creditosMin }}
          </div>

          <button type="button" class="chip-btn chip-btn--plus"
                  (click)="incMin()"
                  [disabled]="cargando">+</button>

          <button type="button" class="chip-any"
                  (click)="setAnyMin()"
                  [disabled]="cargando"
                  [attr.aria-pressed]="(creditosMin === 'cualquiera') ? 'true' : 'false'">
            Cualquiera
          </button>
        </div>
      </div>

      <div class="range-col">
        <label>Máx</label>
        <div class="creditos-chip pretty">
          <button type="button" class="chip-btn chip-btn--minus"
                  (click)="decMax()"
                  [disabled]="cargando || creditosMax === 'cualquiera'">−</button>

          <div class="chip-value">
            {{ creditosMax === 'cualquiera' ? 'Cualquiera' : creditosMax }}
          </div>

          <button type="button" class="chip-btn chip-btn--plus"
                  (click)="incMax()"
                  [disabled]="cargando">+</button>

          <button type="button" class="chip-any"
                  (click)="setAnyMax()"
                  [disabled]="cargando"
                  [attr.aria-pressed]="(creditosMax === 'cualquiera') ? 'true' : 'false'">
            Cualquiera
          </button>
        </div>
      </div>

      <div class="hint">
        Puedes dejar alguno de los límites en “Cualquiera” para indicar un rango abierto.
        Mantenemos el rango consistente (mín ≤ máx) automáticamente.
      </div>
    </div>

    <button (click)="consultarIA()" [disabled]="cargando">Generar Recomendación</button>
  </div>

  <!-- Spinner -->
  <div *ngIf="cargando" class="mensaje-cargando">
    <div class="spinner"></div>
    <p>Consultando, un momento por favor...</p>
  </div>

  <!-- Error -->
  <div *ngIf="hasSearched && error && !cargando" class="respuesta-box">
    <h3 class="titulo-respuesta">Error:</h3>
    <p>{{ error }}</p>
  </div>

  <!-- Resultados principales (tabla 1) -->
  <div *ngIf="hasSearched && !cargando && materias.length > 0" class="respuesta-box">
    <h3 class="titulo-respuesta">Materias recomendadas</h3>

    <table class="tabla-materias">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Grado</th>
          <th>ID</th>
          <th>Créditos</th>
          <th>N° Catálogo</th>
          <th>N° Oferta</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let materia of materias">
          <td>{{ materia.nombre }}</td>
          <td>{{ materia.grado }}</td>
          <td>{{ materia.id }}</td>
          <td>{{ materia.creditos }}</td>
          <td>{{ materia.numero_catalogo }}</td>
          <td>{{ materia.numero_oferta }}</td>
        </tr>
      </tbody>
    </table>

    <p *ngIf="explicacion" class="explicacion-texto">
      <strong>Explicación:</strong> {{ explicacion }}
    </p>
  </div>

  <!-- Resultados sugeridos (tabla 2) -->
  <div *ngIf="hasSearched && !cargando && materiasSugeridas.length > 0" class="sugerencias-box">
    <h3 class="titulo-respuesta">Otras asignaturas relacionadas</h3>
    <p class="sugerencias-parrafo">
      {{ explicacionSugeridas }}
    </p>

    <table class="tabla-materias">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Grado</th>
          <th>ID</th>
          <th>Créditos</th>
          <th>N° Catálogo</th>
          <th>N° Oferta</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let materia of materiasSugeridas">
          <td>{{ materia.nombre }}</td>
          <td>{{ materia.grado }}</td>
          <td>{{ materia.id }}</td>
          <td>{{ materia.creditos }}</td>
          <td>{{ materia.numero_catalogo }}</td>
          <td>{{ materia.numero_oferta }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Caso sin resultados (solo después de buscar) -->
  <div *ngIf="hasSearched && !cargando && !error && materias.length === 0 && materiasSugeridas.length === 0" class="respuesta-box">
    <h3 class="titulo-respuesta">No se encontraron materias que coincidan con tu consulta.</h3>
  </div>
</section>
